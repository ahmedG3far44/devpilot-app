# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches:
      - main  # Adjust to your branch name
  workflow_dispatch:  # Manual trigger option

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Pull latest changes
        working-directory: /var/www/devpilot-app
        run: |
          git fetch origin
          git reset --hard origin/main  # or your branch name
          echo "âœ… Code updated"

      # ============================================
      # BUILD & RESTART SERVER
      # ============================================
      - name: Build and restart server
        working-directory: /var/www/devpilot-app/server
        run: |
          echo "ğŸ”§ Installing server dependencies..."
          npm ci
          
          echo "ğŸ—ï¸  Building server..."
          npm run build
          
          echo "â™»ï¸  Restarting server..."
          npm run start &
          
          # If using PM2, use this instead:
          # pm2 restart devpilot-server || pm2 start npm --name "devpilot-server" -- start
          
          echo "âœ… Server rebuilt and restarted"

      # ============================================
      # BUILD CLIENT
      # ============================================
      - name: Build client
        working-directory: /var/www/devpilot-app/client
        run: |
          echo "ğŸ¨ Installing client dependencies..."
          npm ci
          
          echo "ğŸ—ï¸  Building client..."
          npm run build
          
          echo "âœ… Client built successfully"

      # ============================================
      # RELOAD NGINX
      # ============================================
      - name: Reload Nginx
        run: |
          echo "ğŸ”„ Testing Nginx configuration..."
          sudo nginx -t
          
          echo "ğŸ”„ Reloading Nginx..."
          sudo systemctl reload nginx
          
          echo "âœ… Nginx reloaded successfully"

      # ============================================
      # DEPLOYMENT SUMMARY
      # ============================================
      - name: Deployment complete
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ“Š Deployment summary:"
          echo "  - Code pulled from origin/main"
          echo "  - Server rebuilt and restarted"
          echo "  - Client rebuilt"
          echo "  - Nginx reloaded"
